name: Sync keli Rule Files

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

concurrency:
  group: sync-vpn-tool
  cancel-in-progress: false

jobs:
  sync-files:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 安装 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. 安装 Playwright 并下载浏览器
      - name: Install Playwright and browsers
        run: |
          npm init -y
          npm install playwright
          npx playwright install --with-deps

      # 4. 创建目录
      - name: Prepare directories
        run: |
          mkdir -p Loon/Rule/keli

      # 5. 下载规则文件（带调试信息）
      - name: Download keli Rule files with debug
        run: |
          set -x
          base_agent="Loon/912 CFNetwork/3860.300.31 Darwin/25.2.0"
          declare -A rule_files=(
            ["AI.list"]="https://kelee.one/Tool/Loon/Lsr/AI.lsr"
            ["GoogleVoice.list"]="https://rule.kelee.one/Loon/GoogleVoice.lsr"
            ["Global.list"]="https://rule.kelee.one/Loon/Global.lsr"
            ["LAN_SPLITTER"]="https://kelee.one/Tool/Loon/Lsr/LAN_SPLITTER"
            ["REGION_SPLITTER"]="https://kelee.one/Tool/Loon/Lsr/REGION_SPLITTER"
          )

          for file in "${!rule_files[@]}"; do
            url="${rule_files[$file]}"
            output="Loon/Rule/keli/$file"

            echo "----"
            echo "Downloading Rule: $file"
            echo "URL: $url"
            echo "Output: $output"

            # 检查 HTTP 状态码
            http_code=$(curl -s -o /dev/null -w "%{http_code}" -A "$base_agent" -L --connect-timeout 10 "$url")
            echo "HTTP Status Code: $http_code"

            # 获取响应头前 20 行
            echo "Response headers (partial):"
            curl -s -D - -o /dev/null -A "$base_agent" -L --connect-timeout 10 "$url" | head -n 20

            # 获取 body 前 500 字符，分析 Cloudflare challenge
            echo "Response body snippet (first 500 chars):"
            curl -s -A "$base_agent" -L --connect-timeout 10 "$url" | head -c 500

            # 真正下载文件
            curl -A "$base_agent" -L --retry 3 --retry-delay 5 --connect-timeout 10 "$url" -o "$output"
          done

      # 6. 提交并推送变更
      - name: Commit and push changes if any
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          git config --global user.name 'cngzsunny'
          git config --global user.email 'sunny.rong@gmail.com'

          git add Loon/Rule/keli/*

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Sync keli Rule Files"
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/cngzsunny/vpn_tool.git $BRANCH
          fi
