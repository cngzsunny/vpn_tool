name: Sync keli Rule and PlugIn Files

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

concurrency:
  group: sync-vpn-tool
  cancel-in-progress: false

jobs:
  sync-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          set -x
          mkdir -p Loon/Rule/keli

      - name: Download keli Rule files
        run: |
          set -x
          base_agent="Loon/912 CFNetwork/3860.300.31 Darwin/25.2.0"
          declare -A rule_files=(
            ["AI.list"]="https://kelee.one/Tool/Loon/Lsr/AI.lsr"
            ["GoogleVoice.list"]="https://rule.kelee.one/Loon/GoogleVoice.lsr"
            ["Global.list"]="https://rule.kelee.one/Loon/Global.lsr"
            ["LAN_SPLITTER"]="https://kelee.one/Tool/Loon/Lsr/LAN_SPLITTER"
            ["REGION_SPLITTER"]="https://kelee.one/Tool/Loon/Lsr/REGION_SPLITTER"
          )
          for file in "${!rule_files[@]}"; do
            url="${rule_files[$file]}"
            output="Loon/Rule/keli/$file"

            # 显示即将执行的 curl 命令（调试）
            echo "RUN: curl -A \"$base_agent\" -L --retry 3 --retry-delay 5 --connect-timeout 10 \"$url\" -o \"$output\""

            curl -A "$base_agent" -L --retry 3 --retry-delay 5 --connect-timeout 10 "$url" -o "$output"
          done


      - name: Commit and push changes if any
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          git config --global user.name 'cngzsunny'
          git config --global user.email 'sunny.rong@gmail.com'

          git add Loon/Rule/keli/*

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Sync keli Rule Files"
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/cngzsunny/vpn_tool.git $BRANCH
          fi
